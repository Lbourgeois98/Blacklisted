<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Scammers Dashboard</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <style>
    * { box-sizing: border-box; margin:0; padding:0; }
    body {
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      background: linear-gradient(180deg,#120000 0%, #000 100%);
      color: #fff;
      padding: 28px;
    }
    .container { max-width:1200px; margin:0 auto; }

    h1 { text-align:center; color:#ff3333; font-size:30px; margin-bottom:18px; }

    /* Top input (exact style restored) */
    .admin {
      background: rgba(255,255,255,0.04);
      padding:18px;
      border-radius:12px;
      border:1px solid rgba(255,51,51,0.18);
      margin-bottom:20px;
      display:flex;
      gap:10px;
      align-items:center;
    }
    .admin input[type="text"] {
      flex:1;
      padding:10px 12px;
      border-radius:8px;
      border:2px solid rgba(255,51,51,0.18);
      background:rgba(0,0,0,0.35);
      color:#fff;
      font-size:15px;
    }
    .admin button {
      padding:10px 16px;
      background:#ff3333;
      color:#fff;
      border:none;
      border-radius:8px;
      font-weight:700;
      cursor:pointer;
      transition: all 0.18s;
      box-shadow:0 0 0 rgba(0,0,0,0);
    }
    .admin button:hover { transform:translateY(-2px); box-shadow:0 10px 30px rgba(255,51,51,0.12); }

    /* Grid / Cards */
    .grid {
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(260px,1fr));
      gap:18px;
    }
    .card {
      background: rgba(255,255,255,0.04);
      padding:16px;
      border-radius:12px;
      border:1px solid rgba(255,51,51,0.12);
      display:flex;
      flex-direction:column;
      gap:10px;
      position:relative;
      min-height: 320px;
    }
    .card:hover { box-shadow: 0 18px 40px rgba(0,0,0,0.6); transform:translateY(-6px); }

    .edit-top {
      position:absolute; top:10px; right:10px;
    }
    .edit-top button {
      background: rgba(255,51,51,0.95);
      color:#fff; border:none; padding:6px 10px; border-radius:8px; cursor:pointer; font-weight:700;
      transition: all .12s;
    }
    .edit-top button:hover { transform:scale(1.05); box-shadow:0 8px 20px rgba(255,51,51,0.12); }

    .avatar {
      width:120px; height:120px; border-radius:50%; overflow:hidden;
      margin:0 auto; display:flex; align-items:center; justify-content:center;
      background:linear-gradient(135deg,#ff3b3b,#cc0000);
      color:#fff; font-weight:800; font-size:40px;
      border:3px solid rgba(255,59,59,0.28);
    }
    .avatar img { width:100%; height:100%; object-fit:cover; display:block; }

    .name { text-align:center; font-weight:800; font-size:18px; }

    .spacer { flex:1; } /* keeps buttons bottom-aligned */

    .button-row {
      display:flex; gap:10px; margin-top:8px;
    }
    .button-row .btn {
      flex:1; height:44px; display:flex; align-items:center; justify-content:center;
      border-radius:8px; border:2px solid #ff3333; color:#ff3333; background:transparent; font-weight:700;
      cursor:pointer; text-decoration:none;
      transition: all .18s;
    }
    .button-row .btn:hover {
      background:#ff3333; color:#fff; box-shadow:0 12px 30px rgba(255,59,59,0.12); transform:translateY(-2px);
    }

    .reports-panel {
      display:none;
      margin-top:10px;
      background:rgba(0,0,0,0.28);
      padding:10px; border-radius:8px; max-height:260px; overflow:auto;
    }
    .report-item {
      background:rgba(255,255,255,0.03); padding:8px; border-left:3px solid #ff3333; margin-bottom:8px; border-radius:6px;
      white-space:pre-wrap; font-size:14px; color:#fff;
    }

    .add-report {
      display:flex; gap:8px; margin-top:8px; align-items:flex-start;
    }
    .add-report textarea {
      flex:1; min-height:72px; padding:8px; border-radius:8px; border:none; background:rgba(255,255,255,0.03); color:#fff;
      resize:vertical;
    }
    .add-report button {
      background:#ff3333; color:#fff; border:none; padding:10px 12px; border-radius:8px; font-weight:700; cursor:pointer;
    }

    /* edit row (inline) */
    .edit-row { display:flex; gap:8px; align-items:center; width:100%; margin-top:8px; }
    .edit-row input[type="text"] { flex:1; padding:8px; border-radius:8px; border:none; background:rgba(255,255,255,0.03); color:#fff; }
    .edit-row input[type="file"]{ color:#fff; }
    .edit-actions { display:flex; gap:8px; }
    .small-muted { color: rgba(255,255,255,0.6); font-size:13px; margin-top:6px; text-align:center; }

    /* responsive tweaks */
    @media (max-width:560px){
      .grid { grid-template-columns: repeat(auto-fill, minmax(220px,1fr)); }
      .card { min-height:300px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>⚠️ SCAMMERS ⚠️</h1>

    <div class="admin">
      <input id="profileUrl" placeholder="Paste Facebook profile URL..." />
      <button id="addBtn">Add</button>
    </div>

    <div id="grid" class="grid"></div>
  </div>

  <script>
    // ---------- CONFIG ----------
    const SUPABASE_URL = "https://jikydjqvakjirisekudj.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imppa3lkanF2YWtqaXJpc2VrdWRqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk3MjU1MTUsImV4cCI6MjA3NTMwMTUxNX0.eKtrwpGJuZcfnm2MfOmRlwrunSy6kvXQJqfKJ6DzuG4";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    const STORAGE_BUCKET = "profile-images"; // ensure this exists

    // ---------- HELPERS ----------
    function extractNameFromUrl(url){
      try{
        const u = new URL(url);
        const path = u.pathname.replace(/^\/|\/$/g,'');
        if (path && !path.includes('profile.php')) {
          const raw = decodeURIComponent(path.split('/')[0]).replace(/[._-]/g,' ');
          return raw.split(' ').map(w => w.charAt(0).toUpperCase()+w.slice(1)).join(' ');
        }
        const id = new URLSearchParams(u.search).get('id');
        return id ? `User ${id}` : 'Facebook User';
      }catch(e){
        return 'Facebook User';
      }
    }
    function extractPicFromUrl(url){
      try{
        const u = new URL(url);
        const path = u.pathname.replace(/^\/|\/$/g,'');
        let username = '';
        if (path && !path.includes('profile.php')) username = path.split('/')[0];
        else username = new URLSearchParams(u.search).get('id') || '';
        return username ? `https://graph.facebook.com/${username}/picture?type=large` : null;
      }catch(e){
        return null;
      }
    }

    // ---------- DOM references ----------
    const grid = document.getElementById('grid');
    const addBtn = document.getElementById('addBtn');
    const profileUrlInput = document.getElementById('profileUrl');

    addBtn.addEventListener('click', addProfile);
    profileUrlInput.addEventListener('keypress', e => { if(e.key === 'Enter') addProfile(); });

    // ---------- Core: add profile ----------
    async function addProfile(){
      const raw = profileUrlInput.value.trim();
      if (!raw) return alert('Enter a Facebook profile URL');
      if (!(raw.includes('facebook.com') || raw.includes('fb.com'))) return alert('Not a valid Facebook URL');

      const full = raw.startsWith('http') ? raw : ('https://'+raw);
      const name = extractNameFromUrl(full);
      const picurl = extractPicFromUrl(full);

      // Insert into DB (note: using column 'picurl' lowercase as you said)
      const { data, error } = await supabase.from('scammers').insert([{ name, url: full, picurl }]);
      if (error) {
        console.error('Insert error:', error);
        alert('Failed to add profile: ' + (error.message || JSON.stringify(error)));
        return;
      }
      profileUrlInput.value = '';
      loadProfiles();
    }

    // ---------- Load and render ----------
    async function loadProfiles(){
      const { data, error } = await supabase.from('scammers').select('*').order('id',{ ascending:false });
      if (error) { console.error('fetch scammers error', error); return; }
      renderGrid(data || []);
    }

    function renderGrid(items){
      grid.innerHTML = '';
      for (const item of items){
        const card = document.createElement('div'); card.className = 'card';
        // edit button top-right
        const editTop = document.createElement('div'); editTop.className = 'edit-top';
        const editBtn = document.createElement('button'); editBtn.textContent = 'Edit';
        editBtn.onclick = () => openEditInline(item.id);
        editTop.appendChild(editBtn);
        card.appendChild(editTop);

        // avatar
        const avatar = document.createElement('div'); avatar.className = 'avatar'; avatar.id = `avatar-${item.id}`;
        if (item.picurl){
          const img = document.createElement('img'); img.src = item.picurl; img.alt = item.name || 'avatar';
          img.onerror = () => { img.style.display = 'none'; avatar.textContent = (item.name||'?').charAt(0).toUpperCase(); };
          avatar.appendChild(img);
        } else {
          avatar.textContent = (item.name||'?').charAt(0).toUpperCase();
        }
        card.appendChild(avatar);

        // name
        const nameDiv = document.createElement('div'); nameDiv.className = 'name'; nameDiv.id = `name-${item.id}`;
        nameDiv.textContent = item.name || 'Unknown';
        card.appendChild(nameDiv);

        // spacer to keep buttons bottom-aligned
        const spacer = document.createElement('div'); spacer.className = 'spacer';
        card.appendChild(spacer);

        // buttons row
        const buttonRow = document.createElement('div'); buttonRow.className = 'button-row';
        const viewProfile = document.createElement('a');
        viewProfile.className = 'btn';
        viewProfile.textContent = 'View Profile';
        viewProfile.href = item.url || '#';
        viewProfile.target = '_blank';
        viewProfile.rel = 'noopener noreferrer';
        const viewReports = document.createElement('button');
        viewReports.className = 'btn';
        viewReports.textContent = 'View Reports';
        viewReports.onclick = () => toggleReports(item.id);
        buttonRow.appendChild(viewProfile); buttonRow.appendChild(viewReports);
        card.appendChild(buttonRow);

        // reports panel
        const reportsPanel = document.createElement('div'); reportsPanel.className = 'reports-panel'; reportsPanel.id = `reports-${item.id}`;
        card.appendChild(reportsPanel);

        grid.appendChild(card);
      }
    }

    // ---------- Inline edit ----------
    async function openEditInline(id){
      const card = document.querySelector(`.card:nth-child(1)`) // fallback if anything weird
      const targetCard = Array.from(document.querySelectorAll('.card')).find(c => c.querySelector(`#name-${id}`));
      if (!targetCard) return;
      // hide edit button
      const editTop = targetCard.querySelector('.edit-top'); if (editTop) editTop.style.display = 'none';

      // find current values
      const nameEl = targetCard.querySelector(`#name-${id}`);
      const currentName = nameEl ? nameEl.textContent : '';
      const avatarEl = targetCard.querySelector(`#avatar-${id}`);
      // create edit row
      const editRow = document.createElement('div'); editRow.className = 'edit-row';
      editRow.innerHTML = `
        <input type="text" id="edit-name-${id}" value="${escapeHtmlAttr(currentName)}" />
        <input type="file" id="edit-file-${id}" accept="image/*" />
        <div class="edit-actions">
          <button id="save-edit-${id}">Save</button>
          <button id="cancel-edit-${id}">Cancel</button>
        </div>
      `;
      targetCard.appendChild(editRow);

      document.getElementById(`cancel-edit-${id}`).onclick = () => {
        editRow.remove();
        if (editTop) editTop.style.display = '';
      };

      document.getElementById(`save-edit-${id}`).onclick = async () => {
        const newName = document.getElementById(`edit-name-${id}`).value.trim();
        const fileInput = document.getElementById(`edit-file-${id}`);
        let newPicUrl = null;

        if (fileInput && fileInput.files && fileInput.files[0]) {
          const file = fileInput.files[0];
          const filePath = `scammer-${id}-${Date.now()}-${file.name}`;
          const { data: uploadData, error: uploadError } = await supabase.storage.from(STORAGE_BUCKET).upload(filePath, file);
          if (uploadError) {
            console.error('uploadErr', uploadError);
            alert('Image upload failed: ' + (uploadError.message || JSON.stringify(uploadError)));
            return;
          }
          const { data: urlData } = supabase.storage.from(STORAGE_BUCKET).getPublicUrl(uploadData.path);
          newPicUrl = urlData.publicUrl;
        }

        const updateObj = {};
        if (newName) updateObj.name = newName;
        if (newPicUrl) updateObj.picurl = newPicUrl;

        if (Object.keys(updateObj).length === 0) {
          alert('Nothing to save');
          return;
        }

        const { error } = await supabase.from('scammers').update(updateObj).eq('id', id);
        if (error) {
          console.error('update err', error);
          alert('Save failed: ' + (error.message || JSON.stringify(error)));
          return;
        }

        // update UI
        if (newName) {
          const nameCell = targetCard.querySelector(`#name-${id}`);
          if (nameCell) nameCell.textContent = newName;
        }
        if (newPicUrl) {
          const av = targetCard.querySelector(`#avatar-${id}`);
          if (av) av.innerHTML = `<img src="${newPicUrl}" alt="${escapeHtml(newName||'')}" />`;
        }

        editRow.remove();
        if (editTop) editTop.style.display = '';
      };
    }

    // ---------- Reports functions ----------
    async function toggleReports(id){
      const panel = document.getElementById(`reports-${id}`);
      if (!panel) return;
      if (panel.style.display === 'block') { panel.style.display = 'none'; panel.innerHTML = ''; return; }

      panel.style.display = 'block';
      panel.innerHTML = `<div class="small-muted">Loading reports...</div>`;

      const { data: reports, error } = await supabase
        .from('reports')
        .select('*')
        .eq('scammer_id', id)
        .order('created_at',{ ascending: false });

      if (error) {
        console.error('fetch reports', error);
        panel.innerHTML = `<div class="small-muted">Failed to load reports.</div>`;
        return;
      }

      const listHtml = (reports && reports.length)
        ? reports.map(r => `<div class="report-item">${escapeHtml(r.text || r.description || '')}</div>`).join('')
        : `<div class="small-muted">No reports yet.</div>`;

      panel.innerHTML = `
        <div>${listHtml}</div>
        <div class="add-report">
          <textarea id="report-input-${id}" placeholder="Describe how this person scammed..."></textarea>
          <button id="submit-report-${id}">Submit</button>
        </div>
      `;
      document.getElementById(`submit-report-${id}`).onclick = async () => {
        const ta = document.getElementById(`report-input-${id}`);
        const text = ta.value.trim();
        if (!text) return alert('Write something before submitting');
        const { error } = await supabase.from('reports').insert([{ scammer_id: id, text }]);
        if (error) { console.error('insert report', error); alert('Failed to submit'); return; }
        ta.value = '';
        // refresh report list
        toggleReports(id);
        setTimeout(()=> toggleReports(id), 120);
      };
    }

    // ---------- small utilities ----------
    function escapeHtml(s){ if (!s && s !== 0) return ''; return String(s).replace(/[&<>"']/g, function(m){return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m];}); }
    function escapeHtmlAttr(s){ return escapeHtml(s).replace(/"/g,'&quot;'); }

    // ---------- kickoff ----------
    loadProfiles();

    // expose for debugging
    window.loadProfiles = loadProfiles;
  </script>
</body>
</html>
